<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>予約システム</title>
    <link rel="stylesheet" href="Admission_System_web_style.css">
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdn.jsdelivr.net/npm/vconsole/dist/vconsole.min.js"></script>
</head>
<body>
    <h1>QRコードスキャン</h1>
    <div id="reader" style="width: 300px; height: 300px;"></div>
    <div id="result"></div>

    <main>
        <button id="start-camera" onclick="startCamera()">カメラ起動</button>
        <div id="reader" style="width: 300px; height: 300px; display: none;"></div>
        <div id="result"></div>

        <div class="console" id="console">t</div>
    </main>
  
    <script>
        const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbynz8AcqNKnncLCAPMZPDIntlfGb_3Xs0-7uQgaLOcMCMoGtXFcXy4CNgBloASKaoa-/exec';
        const readerElement = document.getElementById('reader');
        const resultElement = document.getElementById('result');
        let qrCodeScanner = null;
        let CURRENT_TEXT = '';

        const vConsole = new VConsole();

        function startCamera() {
            if (qrCodeScanner) {
                qrCodeScanner.stop().catch((err) => console.error("停止エラー:", err));
            }

            readerElement.style.display = "block";
            qrCodeScanner = new Html5Qrcode("reader");

            qrCodeScanner.start(
                { facingMode: "environment" }, // 背面カメラを使用
                { fps: 10, qrbox: { width: 250, height: 250 } }, // フレームレートとスキャンエリア
                (decodedText) => {
                    handleQRCode(decodedText); // QRコード読み取り成功時の処理
                },
                (error) => {
                    console.warn("QRコード読み取りエラー:", error);
                }
            );
        }

        //スキャン成功時の関数
        const onScanSuccess = (decodedText, decodedResult) => {
        console.log('スキャン成功', decodedText, CURRENT_TEXT);
        if (CURRENT_TEXT !== decodedText) {
            CURRENT_TEXT = decodedText;
            append(decodedText);
            beep();
            google.script.run
            .withFailureHandler(function (error) {
                append(`"${decodedText}"の保存に失敗しました: ${error}`);
            })
            .onScan(decodedText);
        }
        };

        //サーバー側に送る関数
        async function handleQRCode(decodedText) {
            //console.log("QRコード内容:", decodedText); // ここで読み取ったデータを確認
            try {
                console.log(typeof Html5Qrcode);
                // Base64デコードとURLデコードを適用

                  // Base64デコードとJSONパースを試行
                const decodedBase64 = decodeURIComponent(escape(atob(decodedText))); // Base64デコード + URLデコード
                const qrData = JSON.parse(decodedBase64); // JSONパース
                //console.log("デコードされたデータ:", qrData);
                const username = qrData.u;
                const password = qrData.p;

                        // 送信データを準備
                const formData = new FormData();
                formData.append('action', 'checkStatus'); // ログインを指定
                formData.append('username', qrData.u);
                formData.append('password', qrData.p);
                console.log('フォームデータ:', formData);
                console.log('ユーザーネームとパスワード:', qrData.u,qrData.p);
            
                // QRコードを読み取ったらスキャナーを停止
                if (qrCodeScanner) {
                    await qrCodeScanner.stop(); // スキャナーを停止
                    console.log("QRコード読み取りを停止しました");
                }
                
                //サーバー側にデータを送信
                const response = await fetch(GAS_API_URL, {
                    method: 'POST',
                    body: formData
                });
                
                if(response.ok)
                {
                const result = await response.json();
                console.log("サーバー応答:", JSON.stringify(result, null , 2));
                    
                //サーバーのレスポンスがエラーの場合
                if (result.error) {
                    resultElement.innerHTML = `<p style="color:red;">${result.error}</p>`;
                    return;
                }
                
                const html5QrcodeScanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 240 });
                html5QrcodeScanner.render(onScanSuccess);

                    resultElement.innerHTML = `
                        <p>予約者: ${result.username}</p>
                        <p>予約番号: ${result.reservationNumber}</p>
                        <p>入場可能: ${result.possible}</p>
                        <p>入場済み: ${result.already}</p>
                    `;
                } else {
                    resultElement.innerHTML = `<p style="color:red;">予約が見つかりません。</p>`;
                }

            } catch (error) {
                console.error("デコードエラー:", error);
                resultElement.innerHTML = `<p style="color:red;">QRコードの内容が無効です。</p>`;
                return;
            } finally {
                //読み取りを停止（念のため再呼び出し）
                if (qrCodeScanner) {
                    qrCodeScanner.stop().catch((err) => console.error("停止エラー:", err));
                }
            }
        }
    </script>
</body>
